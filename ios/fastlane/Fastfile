# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

module Constant
  # í”„ë¡œì íŠ¸ ì´ë¦„
  PROJECT = "ChabapApp.xcodeproj"
  # workspace
  WORKSPACE = "ChabapApp.xcworkspace"
  # ìŠ¤í‚¤ë§ˆ
  SCHEME = "ChabapApp"
  # configurations
  DEBUG = "Debug"
  ALPHA = "Alpha"
  BETA = "Beta"
  RELEASE = "Release"
  # ì•± ì˜¬ë¦¬ê³  ë‚˜ì„œ ë°°í¬í•  ë•Œ mattermost hook
  MATTERMOST_URL = "https://mm.starlabs.co.kr/hooks/fsyafx65nbdqjrro8fyi5epsuw"
  # mattermost channel
  MATTERMOST_CHANNEL = "cicd"
  # mattermost icon
  MATTERMOST_ICON = "https://jenkins.io/images/logos/jenkins/jenkins.png"
  # ì¸ì¦ì„œë¥¼ ê°€ì ¸ì˜¬ app id
  APP_IDENTIFIERS = ["kr.co.chabap"]
  # íŒŒì´ì–´ë² ì´ìŠ¤ ë°°í¬ì— ì˜¬ë¦´ ì•±
  FIREBASE_APP_ID = "1:1004320714067:ios:394416c9d40c06802085a6"
  # íŒŒì´ì–´ë² ì´ìŠ¤ ë°°í¬ í…ŒìŠ¤íŠ¸ ê·¸ë£¹
  FIREBASE_TEST_GROUP = "ì—°êµ¬ê°œë°œì‹¤"
  # íŒŒì´ì–´ë² ì´ìŠ¤ ë°°í¬ë¥¼ í•˜ê³  ë²„ì „ ë²”í”„ë¥¼ í‘¸ì‹œí•  ë¦¬ëª¨íŠ¸ì˜ ì´ë¦„
  REMOTE_NAME = "origin"
  
end

def get_version()
  return get_version_number(xcodeproj: Constant::PROJECT, target: Constant::SCHEME)
end

def get_build()
  return get_build_number(xcodeproj: Constant::PROJECT)
end

def set_version(version)
  puts("ë²„ì „ =======================> #{version}")
  increment_version_number(
    version_number: version,
    xcodeproj: Constant::PROJECT
  )
  # update_info_plist(
  #   plist_path: "ChabapApp/Info.plist",
  #   block: proc do |plist|
  #     versionSpecifiers = plist["PreferenceSpecifiers"].find{|specifiers|specifiers["Key"] == "Version"}
  #     versionSpecifiers["DefaultValue"] = version
  #   end
  # )
end

def set_build(build)
  increment_build_number(
    build_number: build,
    xcodeproj: Constant::PROJECT
  )
end

def increase_build(increase_by = 1)
  build = get_build()
  splited = build.split('.')
  major = splited[0]
  minor = splited[1]
  patch = splited[2]
  build_number = splited[3]
  new_build = "#{major}.#{minor}.#{patch}.#{build_number.to_i + increase_by}"
  set_build(new_build)
  return new_build
end

def increase_version(increase_by = 1)
  version = get_version()
  splited = version.split('.')
  major = splited[0]
  minor = splited[1]
  patch = splited[2]
  new_version = "#{major}.#{minor}.#{patch}.#{patch.to_i + increase_by}"
  new_build = "#{new_version}.0"
  set_version(new_version)
  set_build(new_build)
  return new_version
end

def on_success(message_value)
  version = get_version()
  build = get_build()
  mattermost(
    url: Constant::MATTERMOST_URL,
    channel: Constant::MATTERMOST_CHANNEL,
    username: 'jskim91',
    text: message_value + "\nversion: #{version}\nbuild: #{build}",
    icon_url: Constant::MATTERMOST_ICON,
  )
end

def on_error(exception)
  puts("On error exception ==> #{exception}")
  version = get_version()
  build = get_build()
  mattermost(
    url: Constant::MATTERMOST_URL,
    channel: Constant::MATTERMOST_CHANNEL,
    username: 'jskim91',
    text: "<!here> fastlane ë¹Œë“œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nversion: #{version}\nbuild: #{build}",
    icon_url: Constant::MATTERMOST_ICON,
  )
end

def version_bump(options)
  if options[:type]
    type = options[:type].strip
    if type == 'version'
      puts("============== ë²„ì „ì´ ì—…ë°ì´íŠ¸ ë©ë‹ˆë‹¤. ================")
      increase_version()
    else
      puts("============== ë¹Œë“œê°€ ì—…ë°ì´íŠ¸ ë©ë‹ˆë‹¤. ================")
      increase_build()
    end
  else 
    puts("============ ë¹Œë“œ ë° ë²„ì „ ì—…ë°ì´íŠ¸ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ================")
  end
end
# def get_commit_log()
#   puts("Last tag ==> ")
#   last_tag = last_git_tag()
#   puts("#{last_tag}")
#   add_git_tag
#   changelog = changelog_from_git_commits(
#     between: [last_tag, "HEAD"]
#   )
#   current_build = get_build()
#   log = """#{current_build} ë²„ì „ì€ ì•„ë˜ì™€ ê°™ì€ ìˆ˜ì •ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤. #{changelog}"""

#   return log
# end
def get_release_note()
  build = get_build()
  version = get_version()
  release_notes = get_git_commits()
  puts("=================================================================================")
  puts("============================= #{release_notes} =============================")
  puts("=================================================================================")
  return release_notes
end

def get_git_commits()
  puts("=================================================================================")
  puts("======================ì»¤ë°‹ ë¡œê·¸=============================")
  puts("=================================================================================")
  changelog = changelog_from_git_commits(
    between: [last_git_tag, "HEAD"],  # Optional, lets you specify a revision/tag range between which to collect commit info
    pretty: "- (%ae) %s",# Optional, lets you provide a custom format to apply to each commit when generating the changelog text
    date_format: "short",# Optional, lets you provide an additional date format to dates within the pretty-formatted string
    match_lightweight_tag: false,  # Optional, lets you ignore lightweight (non-annotated) tags when searching for the last tag
    merge_commit_filtering: "exclude_merges" # Optional, lets you filter out merge commits
  )
  puts("ë³€ê²½ ë¡œê·¸ :: #{changelog}")
  return changelog
end

def git_tagging()
  version = get_version()
  build = get_build()
  add_git_tag(
    grouping: "fastlane-builds",
    includes_lane: true,
    prefix: "v",
    postfix: "-RC-#{build}",
    build_number: version
  )
end

def upload_to_firebase(options)
  puts("=================================================================================")
  puts("=========================== Match pending ===========================")
  puts("=================================================================================")
  match(app_identifier: Constant::APP_IDENTIFIERS, type: "adhoc")
  puts("=================================================================================")
  puts("=========================== Match success ===========================")
  puts("=================================================================================")
  build_app(workspace: Constant::WORKSPACE, scheme: Constant::SCHEME, configuration: Constant::ALPHA)
  # workspace: "ChabapApp.xcworkspace", scheme: "ChabapApp"
  
  # release note
  release_notes = get_release_note()
  
  # ê¹ƒ íƒœê·¸ ì¶”ê°€
  git_tagging()
  
  # firebase ë°°í¬
  firebase_app_distribution(
    app: Constant::FIREBASE_APP_ID,
    groups: Constant::FIREBASE_TEST_GROUP,
    release_notes: release_notes
  )

  mattermost_message = """<!here> íŒŒì´ì–´ë² ì´ìŠ¤ì— ë°°í¬ ë²„ì „ì´ ì˜¬ë¼ê°”ìŠµë‹ˆë‹¤.\nRelease Note:\n#{release_notes}"""
  
  on_success(mattermost_message)

  # version up
  version_bump(options)
end

platform :ios do
  desc "Push a new release build to the Distribution"
  lane :release do
    begin
      match(app_identifier: Constant::APP_IDENTIFIERS, type: "adhoc")
      build_app(project: Constant::PROJECT, scheme: Constant::SCHEME)
      on_success("ì‹¬ì‚¬ë²„ì „ ë¹Œë“œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ì—…ë¡œë“œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.")
      upload_to_app_store(skip_metadata: true, skip_screenshots: true)
      on_success("ì‹¬ì‚¬ë²„ì „ ì—…ë¡œë“œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.")
    rescue => exception
      on_error(exception)
    end
  end

  lane :develop do
    begin
      match(app_identifier: Constant::APP_IDENTIFIERS, type: "appstore")
      build_app(project: Constant::PROJECT, scheme: Constant::SCHEME, configuration: Constant::Beta)
      on_success("ê°œë°œë²„ì „ ë¹Œë“œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ì—…ë¡œë“œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.")
      upload_to_testflight(skip_submission: true, skip_waiting_for_build_processing: true)
      on_success("ê°œë°œë²„ì „ ì—…ë¡œë“œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.")
    rescue => exception
      on_error(exception)
    end
  end

  lane :firebase do |options|
    begin
      upload_to_firebase(options)
    rescue => exception
      on_error(exception)
    end
  end

  # get_version ëª…ë ¹ì–´
  def command_gv()
    version = get_version()
    puts("í˜„ì¬ ë²„ì „ì€ #{version} ì…ë‹ˆë‹¤. ğŸ‰")
  end

  lane :get_version do
    command_gv()
  end
  lane :gv do
    command_gv()
  end

  # get_build ëª…ë ¹ì–´
  def command_gb()
    build = get_build()
    puts("í˜„ì¬ ë¹Œë“œëŠ” #{build} ì…ë‹ˆë‹¤. ğŸ‰")
  end

  lane :get_build do
    command_gb()
  end

  # set_version ëª…ë ¹ì–´
  def command_sv(options)
    version = get_version()
    new_version = options[:number].strip
    new_build = "#{new_version}.0"
    set_version(new_version)
    set_build(new_build)
    puts("ë²„ì „ì´ #{version} ì—ì„œ #{new_version} ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‰")
    puts("ë¹Œë“œê°€ #{new_build} ë¡œ ìë™ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‰")
  end

  lane :set_version do |options|
    command_sv(options)
  end
  lane :sv do |options|
    command_sv(options)
  end

  # set_build ëª…ë ¹ì–´
  def command_sb(options)
    build = get_build()
    new_build = options[:number].strip
    set_build(new_build)
    puts("ë¹Œë“œê°€ #{build} ì—ì„œ #{new_build} ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‰")
  end

  lane :sb do |options|
    command_sb(options)
  end

  # increase_version ëª…ë ¹ì–´
  def command_iv(options)
    increase_by = 1
    if options[:by]
      increase_by = options[:by].to_i
    end

    new_version = increase_version(increase_by)
    puts("ë²„ì „ì´ #{new_version} ìœ¼ë¡œ ì˜¬ë¼ê°”ìŠµë‹ˆë‹¤. ğŸ‰")
    puts("ë¹Œë“œê°€ #{new_version}.0 ìœ¼ë¡œ ìë™ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‰")
  end

  lane :increase_version do |options|
    command_iv(options)
  end
  lane :iv do |options|
    command_iv(options)
  end

  # increase_build ëª…ë ¹ì–´
  def command_ib(options)
    increase_by = 1
    if options[:by]
      increase_by = options[:by].to_i
    end
    new_build = increase_build(increase_by)
    puts("ë¹Œë“œê°€ #{new_build} ìœ¼ë¡œ ì˜¬ë¼ê°”ìŠµë‹ˆë‹¤. ğŸ‰")
  end

  lane :increase_build do |options|
    command_ib(options)
  end
  lane :ib do |options|
    command_ib(options)
  end

  lane :commits do
    get_git_commits()
  end

  lane :agt do
    git_tagging()
  end

  lane :bump do |options|
    version_bump(options)
  end
end
# match(type: "appstore")
# build_app(workspace: "ChabapApp.xcworkspace", scheme: "ChabapApp")
# upload_to_app_store(skip_metadata: true, skip_screenshots: true)
# match(
#   git_url: 'git@gitlab.com:starlabs-rnd/chabap/chabap-app.git'
#   type: "development",
#   storage_mode: 'git',
#   readonly: true,
#   keychain_name: 'jskim91',
#   keychain_password: 'wlstjr129@'
# )
# increment_build_number(xcodeproj: "ChabapApp.xcodeproj")
# build_app(workspace: "ChabapApp.xcworkspace", scheme: "ChabapApp")
# upload_to_app_store
# end
#   lane :increase_build_number do
#     identifier = get_info_plist_value(path: "./ChabapApp/Info.plist", key: "CFBundleVersion")
#     new_identifier = (identifier.to_i + 1).to_s
#     set_info_plist_value(path: "./ChabapApp/Info.plist", key: "CFBundleVersion", value: new_identifier)
#     puts("ë²„ì „ ë„˜ë²„ " + identifier + "ê°€ " + new_identifier + "ë¡œ ë³€ê²½ ë˜ì—ˆìŠµë‹ˆë‹¤.")
